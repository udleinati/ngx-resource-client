!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("util"),require("rxjs"),require("dexie"),require("@nguniversal/express-engine/tokens"),require("rxjs/operators"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","util","rxjs","dexie","@nguniversal/express-engine/tokens","rxjs/operators","lodash"],t):t(e["ngx-jsonapi"]={},e.ng.core,e.common,e.http,e.util,e.rxjs,e.Dexie,e.tokens,e.operators,e.lodash)}(this,function(e,i,c,u,o,s,t,r,d,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var a,p=(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),h=function(r,n){var i,o,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},l=function(){this.number=1,this.total_resources=0,this.size=0,this.resources_per_page=0},f=(v.propagateLoaded=function(e,t){for(var r in e){var n=e[r];n instanceof x&&n.setLoaded(t&&n.builded)}},v);function v(){}var g=(y.prototype.applyParams=function(e,t){var r;if(void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include),void 0===(r=t).id&&void 0===r.include_get&&void 0===r.include_save||!t.include_get||this.setInclude(this.includes.concat(t.include_get)),t.fields&&0<Object.keys(t.fields).length)for(var n in t.fields){var i="fields["+n+"]="+t.fields[n].join(",");this.get_params.push(i)}},y.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},y.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},y.prototype.get=function(){var e=this.get_params.slice();return 0<this.includes.length&&e.push("include="+this.includes.join(",")),this.paths.join("/")+(0<e.length?te.injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},y.prototype.setInclude=function(e){this.includes=e},y);function y(){this.paths=[],this.includes=[],this.get_params=[]}var b=(m.json_array2resources_array_by_type=function(e){var t={},r={};for(var n in m.json_array2resources_array(e,t),t){var i=t[n];i.type in r||(r[i.type]={}),r[i.type][i.id]=i}return r},m.json2resource=function(e,t){if(m.getService(e.type))return m.procreate(e);i.isDevMode()&&console.warn("`"+e.type+"`","service not found on json2resource().","Use @Autoregister() on service and inject it on component.");var r=new j;return r.id=e.id,r.type=e.type,r},m.getService=function(e){return te.me.getResourceService(e)},m.getServiceOrFail=function(e){return te.me.getResourceServiceOrFail(e)},m.buildIncluded=function(e){return"included"in e&&e.included?m.json_array2resources_array_by_type(e.included):{}},m.procreate=function(e){"type"in e&&"id"in e||console.error("Jsonapi Resource is not correct",e);var t=L.getInstance().getOrCreateResource(e.type,e.id);return t.fill({data:e}),t.is_new=!1,t},m.json_array2resources_array=function(e,t){void 0===t&&(t={});for(var r=0,n=e;r<n.length;r++){var i=n[r],o=m.json2resource(i,!1);t[o.type+"_"+o.id]=o}},m);function m(){}var _=(w.prototype.buildRelationships=function(){for(var e in this.relationships_from){var t=this.relationships_from[e];this.relationships_dest[e]&&null===t.data&&(this.relationships_dest[e].data=null,this.relationships_dest[e].builded=!0,this.relationships_dest[e].is_loading=!1,this.relationships_dest[e].loaded=!0),t.data&&(this.relationships_dest[e]instanceof x?this.__buildRelationshipHasMany(t,e):this.relationships_dest[e]instanceof k&&this.__buildRelationshipHasOne(t,e))}},w.prototype.__buildRelationshipHasMany=function(e,t){if(0===e.data.length)return this.relationships_dest[t]=new x,void(this.relationships_dest[t].builded=!0);this.relationships_dest[t].fill(e)},w.prototype.__buildRelationshipHasOne=function(e,t){var r;"type"in e.data?(this.relationships_dest[t].data||(this.relationships_dest[t].data=new j),e.data.id!==this.relationships_dest[t].data.id&&(this.relationships_dest[t].data=new j,this.relationships_dest[t].data.type=e.data.type),this.relationships_dest[t].data.id===e.data.id&&this.relationships_dest[t].data.attributes&&0!==Object.keys(this.relationships_dest[t].data.attributes).length||((r=this.__buildRelationship(e.data))?(this.relationships_dest[t].data=r,this.relationships_dest[t].builded=!0):(this.relationships_dest[t].data.id=e.data.id,this.relationships_dest[t].data.type=e.data.type))):this.relationships_dest[t].data=[]},w.prototype.__buildRelationship=function(e){if(e.type in this.included_resources&&e.id in this.included_resources[e.type]){var t=this.included_resources[e.type][e.id];return L.getInstance().setResource(t,!0),t}this.getService(e.type);var r=L.getInstance().getResource(e.type,e.id);if(r)return r},w);function w(e,t,r,n){this.getService=e,this.relationships_from=t,this.relationships_dest=r,this.included_resources=n}var j=(R.prototype.reset=function(){for(var e in this.id="",this.attributes={},this.is_new=!0,this.relationships)this.relationships[e]=new(this.relationships[e]instanceof x?x:k)},R.prototype.toObject=function(e){var t,r={},n=[],i=[],o=(e=Object.assign({},F.ParamsResource,e)).include||[];for(var s in e.include_save&&(o=o.concat(e.include_save)),this.relationships){var a=this.relationships[s];if(a instanceof x){a.builded||a.data&&0!==a.data.length?r[s]={data:[]}:delete r[s];for(var c=0,u=a.data;c<u.length;c++){var d=u[c],p={id:d.id,type:d.type};r[s].data.push(p);var h=d.type+"_"+d.id;-1===i.indexOf(h)&&o&&-1!==o.indexOf(s)&&(i.push(h),n.push(d.toObject({}).data))}}else{if(null===a.data||void 0===a.data){r[s]={data:a.data};continue}a instanceof k||console.warn(a," is not DocumentCollection or DocumentResource");var l=a.data;if(a.data&&!("id"in a.data)&&0<Object.keys(a.data).length&&console.warn(s+" defined with hasMany:false, but I have a collection"),l.id&&l.type)r[s]={data:{id:l.id,type:l.type}};else if(!a.builded&&!l.id&&!l.type){delete r[s];continue}h=l.type+"_"+l.id;-1===i.indexOf(h)&&o&&-1!==o.indexOf(s)&&(i.push(h),n.push(l.toObject({}).data))}}this.getService()&&this.getService().parseToServer?(t=Object.assign({},this.attributes),this.getService().parseToServer(t)):t=this.attributes;var f={data:{type:this.type,id:this.id,attributes:t,relationships:r}};return this.meta&&(f.data.meta=this.meta),e.meta&&(f.meta=e.meta),0<n.length&&(f.included=n),f},R.prototype.fill=function(e){this.id=e.data.id||"",this.attributes=Object.assign({},this.attributes||{},e.data.attributes),this.data_resource=e,this.is_new=!1;var t,r=b.getService(e.data.type);return!this.relationships&&r&&(this.relationships=(new r.resource).relationships),!!r&&(!Object.keys(this.attributes).length||(t=b.getService(this.type))&&"parseFromServer"in t&&t.parseFromServer(this.attributes),"cache_last_update"in e.data&&(this.cache_last_update=e.data.cache_last_update),new _(b.getService,e.data.relationships||{},this.relationships,b.buildIncluded(e)).buildRelationships(),!0)},R.prototype.addRelationship=function(e,t){var r=this.relationships[t||e.type];r instanceof x?r.replaceOrAdd(e):r.data=e},R.prototype.addRelationships=function(e,t){var r=this;if(0!==e.length){if(!(this.relationships[t]instanceof x))throw new Error("addRelationships require a DocumentCollection (hasMany) relation.");e.forEach(function(e){r.addRelationship(e,t)})}},R.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;var r=this.relationships[e];return r instanceof x?(r.data=r.data.filter(function(e){return e.id!==t}),0===r.data.length&&(r.builded=!0)):r.data=null,!0},R.prototype.hasManyRelated=function(e){return this.relationships[e]&&0<this.relationships[e].data.length},R.prototype.hasOneRelated=function(e){return Boolean(this.relationships[e]&&this.relationships[e].data.type&&""!==this.relationships[e].data.type)},R.prototype.restore=function(e){return void 0===e&&(e={}),e.meta=Object.assign({},e.meta,{restore:!0}),this.save(e)},R.prototype.getService=function(){return b.getServiceOrFail(this.type)},R.prototype.delete=function(){return this.getService().delete(this.id)},R.prototype.save=function(e){var t=this;if(e=Object.assign({},F.ParamsResource,e),this.is_saving||!this.loaded)return s.of({});this.is_saving=!0;var r=new s.Subject,n=this.toObject(e);""===this.id&&delete n.data.id;var i=new g;return i.applyParams(this.getService(),e),this.id&&i.appendPath(this.id),te.exec(i.get(),this.is_new?"POST":"PATCH",n,!0).subscribe(function(e){t.is_saving=!1,t.id||(L.getInstance().deprecateCollections(i.get()),(new z).deprecateCollection(i.get())),"id"in e.data?(t.id=e.data.id,t.fill(e)):o.isArray(e.data)&&console.warn("Server return a collection when we save()",e.data),r.next(e),r.complete()},function(e){t.is_saving=!1,r.error("data"in e?e.data:e)}),r.asObservable()},R.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},R.prototype.setLoadedAndPropagate=function(e){this.setLoaded(e),f.propagateLoaded(this.relationships,e)},R.prototype.setSource=function(e){this.source=e},R.prototype.setSourceAndPropagate=function(e){for(var t in this.setSource(e),this.relationships){var r=this.relationships[t];r instanceof x&&r.setSource(e)}},R.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},R);function R(){this.id="",this.type="",this.attributes={},this.relationships={},this.links={},this.is_new=!0,this.is_saving=!1,this.is_loading=!1,this.loaded=!0,this.source="new",this.cache_last_update=0,this.ttl=0}function O(){this.builded=!1,this.is_loading=!0,this.loaded=!1,this.source="new",this.cache_last_update=0,this.meta={}}var S,C=(p(P,S=O),P.prototype.trackBy=function(e){return e.id},P.prototype.find=function(e){if("ids"===this.content)return null;for(var t=0;t<this.data.length;t++)if(this.data[t].id===e)return this.data[t];return null},P.prototype.fill=function(e){this.data_collection=e,b.buildIncluded(e),this.page&&e.meta&&(this.page.number=e.meta.page||1,this.page.resources_per_page=e.meta.resources_per_page||null,this.page.size=e.meta.resources_per_page||null,this.page.total_resources=e.meta.total_resources||null);var t={};this.data.length=0,this.builded=e.data&&0===e.data.length;for(var r=0,n=e.data;r<n.length;r++){var i=n[r];try{var o=this.getResourceOrFail(i);o.fill({data:i}),t[i.id]=i.id,this.data.push(o),0<Object.keys(o.attributes).length&&(this.builded=!0)}catch(e){this.content="ids",this.builded=!1,this.data.push({id:i.id,type:i.type})}}for(var s=void 0;s<this.data.length;s++)this.data[s].id in t||delete this.data[s];this.meta=e.meta||{},"cache_last_update"in e&&(this.cache_last_update=e.cache_last_update)},P.prototype.getResourceOrFail=function(e){var t=this.find(e.id);if(null!==t)return t;var r=b.getService(e.type);if(!r)throw i.isDevMode()&&console.warn("The relationship relation_alias? (type "+e.type+") cant be generated because service for this type has not been injected."),new Error("Cant create service for "+e.type);return r.getOrCreateResource(e.id)},P.prototype.replaceOrAdd=function(e){null===this.find(e.id)&&this.data.push(e)},P.prototype.hasMorePages=function(){return!this.page.size||this.page.size<1?null:this.page.size*(this.page.number-1)+this.data.length<this.page.total_resources},P.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},P.prototype.setLoadedAndPropagate=function(t){this.setLoaded(t),"ids"!==this.content&&this.data.forEach(function(e){f.propagateLoaded(e.relationships,t)})},P.prototype.setBuilded=function(e){this.builded=e},P.prototype.setBuildedAndPropagate=function(t){this.setBuilded(t),"ids"!==this.content&&this.data.forEach(function(e){e.setLoaded(t)})},P.prototype.setSource=function(e){this.source=e},P.prototype.setSourceAndPropagate=function(t){this.setSource(t),this.data.forEach(function(e){e instanceof j&&e.setSource(t)})},P.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},P.prototype.setCacheLastUpdateAndPropagate=function(t){void 0===t&&(t=Date.now()),this.setCacheLastUpdate(t),this.data.forEach(function(e){e instanceof j&&e.setCacheLastUpdate(t)})},P.prototype.toObject=function(t){return this.builded?{data:this.data.map(function(e){return e.toObject(t).data})}:{data:this.data}},P);function P(){var e=S.apply(this,arguments)||this;return e.data=[],e.page=new l,e.ttl=0,e.content="ids",e}var E,x=(p(D,E=C),D);function D(){var e=E.apply(this,arguments)||this;return e.data=[],e.content="collection",e}var F=(A.newCollection=function(){return new x},A.isObjectLive=function(e,t){return 0<=e&&Date.now()<=t+1e3*e},A.forEach=function(t,r){Object.keys(t).forEach(function(e){r(t[e],e)})},A);function A(){}F.ParamsResource={beforepath:"",ttl:void 0,include:[],fields:{},id:""},F.ParamsCollection={beforepath:"",ttl:void 0,include:[],remotefilter:{},fields:{},smartfilter:{},sort:[],page:new l,store_cache_method:"individual",storage_ttl:0,cachehash:""};var L=(I.getInstance=function(){return I.instance||(I.instance=new I),I.instance},I.prototype.clearCache=function(){this.resources={},this.collections={},I.instance=null},I.prototype.getResource=function(e,t){return this.getKey(e,t)in this.resources?this.resources[this.getKey(e,t)]:null},I.prototype.getResourceOrFail=function(e,t){if(this.getKey(e,t)in this.resources)return this.resources[this.getKey(e,t)];throw new Error("The requested resource does not exist in cache memory")},I.prototype.getKey=function(e,t){return e+"."+t},I.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=new x,this.collections[e].source="new"),this.collections[e]},I.prototype.setCollection=function(e,t){e in this.collections||(this.collections[e]=new x);for(var r=0;r<t.data.length;r++){var n=t.data[r];this.setResource(n,!0)}this.collections[e].data=t.data,this.collections[e].page=t.page,this.collections[e].cache_last_update=t.cache_last_update},I.prototype.getOrCreateResource=function(e,t){var r=this.getResource(e,t);return null!==r||((r=b.getServiceOrFail(e).new()).id=t,this.setResource(r,!1)),r},I.prototype.setResource=function(e,t){void 0===t&&(t=!1),this.getKey(e.type,e.id)in this.resources?this.fillExistentResource(e):this.resources[this.getKey(e.type,e.id)]=e,this.resources[this.getKey(e.type,e.id)].cache_last_update=t?Date.now():0},I.prototype.deprecateCollections=function(e){for(var t in void 0===e&&(e=""),this.collections)t.includes(e)&&(this.collections[t].cache_last_update=0);return!0},I.prototype.removeResource=function(r,n){var e=this.getResource(r,n);if(e){for(var t in F.forEach(this.collections,function(e,t){e.data.splice(e.data.findIndex(function(e){return e.type===r&&e.id===n}),1)}),e.attributes={},e.relationships)null!==e.relationships[t].data&&void 0!==e.relationships[t].data&&(e.relationships[t].data instanceof Array?e.relationships[t].data=[]:e.relationships[t].data instanceof Object&&delete e.relationships[t].data);delete this.resources[this.getKey(r,n)]}},I.prototype.fillExistentResource=function(e){var t=this.getResourceOrFail(e.type,e.id);t.attributes=Object.assign({},t.attributes,e.attributes),t.relationships=t.relationships||e.relationships},I);function I(){this.resources={},this.collections={}}var T,k=(p(q,T=O),q.prototype.fill=function(e){this.builded=!1,this.content="id",null!==(this.data_resource=e)?(this.data||(this.data=L.getInstance().getOrCreateResource(e.data.type,e.data.id)),this.data.fill(e)&&(this.builded=!0,this.content="resource"),this.meta=e.meta||{}):this.data=null},q.prototype.unsetData=function(){this.data=void 0,this.builded=!1},q);function q(){var e=T.apply(this,arguments)||this;return e.data=new j,e.builded=!1,e.content="id",e}var J=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}i((c=c.apply(o,s||[])).next())})},M=(K.prototype.getElement=function(r,n){return void 0===n&&(n="elements"),J(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return[4,K.db.open()];case 1:return e.sent(),[4,K.db.table(n).get(r)];case 2:if(void 0===(t=e.sent()))throw new Error(r+" not found.");return[2,t]}})})},K.prototype.getElements=function(r,n){return void 0===n&&(n="elements"),J(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:return t={},[4,K.db.table(n).where(":id").anyOf(r).each(function(e){t[e.data.type+"."+e.data.id]=e})];case 1:return e.sent(),[2,r.map(function(e){return t[e]})]}})})},K.prototype.updateElements=function(r,e,n){return void 0===n&&(n="elements"),J(this,void 0,void 0,function(){var t=this;return h(this,function(e){return[2,K.db.open().then(function(){return J(t,void 0,void 0,function(){return h(this,function(e){return""===r?[2,K.db.table(n).clear()]:[2,K.db.table(n).where(":id").startsWith(r).delete().then(function(){})]})})})]})})},K.prototype.saveElements=function(n,i){return void 0===i&&(i="elements"),J(this,void 0,void 0,function(){var t,r;return h(this,function(e){return t=[],r=n.map(function(e){return t.push(e.key),e.content}),[2,K.db.open().then(function(){K.db.table(i).bulkPut(r,t)})]})})},K);function K(){K.db||(K.db=new t("dexie_data_provider"),K.db.version(1).stores({collections:"",elements:""}))}var H=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}i((c=c.apply(o,s||[])).next())})};var z=(B.prototype.getResource=function(i,o){return void 0===o&&(o=[]),H(this,void 0,void 0,function(){var r,n,t;return h(this,function(e){switch(e.label){case 0:return[4,this.getDataResources([i])];case 1:if(void 0===(r=e.sent().shift()))throw new Error("Resource "+i+" don't found.");return 0===o.length?[2,r]:(n=[],o.forEach(function(e){if(!r||!r.data.relationships||!r.data.relationships[e])throw new Error("We dont have relation_alias on stored data resource");var t=r.data.relationships[e].data;t instanceof Array?t.forEach(function(e){n.push(B.getResourceKey(e))}):t&&"id"in t&&n.push(B.getResourceKey(t))}),[4,this.getDataResources(n)]);case 2:return t=e.sent(),[2,Object.assign({},r,{included:t.map(function(e){return e.data})})]}})})},B.prototype.getCollection=function(s,a){return void 0===a&&(a=[]),H(this,void 0,void 0,function(){var t,n,r,i,o;return h(this,function(e){switch(e.label){case 0:return[4,this.getDataCollection(s)];case 1:return t=e.sent(),[4,this.getDataResources(t.keys)];case 2:return(n=e.sent(),r={data:n.map(function(e){return e.data}),cache_last_update:t.updated_at},0===a.length)?[2,r]:(i=[],a.forEach(function(r){n.forEach(function(e){var t;e.data.relationships&&e.data.relationships[r]&&((t=e.data.relationships[r].data)instanceof Array?t.forEach(function(e){i.push(B.getResourceKey(e))}):"id"in t&&i.push(B.getResourceKey(t)))})}),[4,this.getDataResources(i)]);case 3:return o=e.sent(),[2,Object.assign({},r,{included:o.map(function(e){return e.data})})]}})})},B.prototype.getDataCollection=function(t){return H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.getElement(t,"collections")]})})},B.prototype.getDataResources=function(t){return H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.getElements(t,"elements")]})})},B.prototype.saveCollection=function(e,t,r){void 0===r&&(r=[]),this.dataProvider.saveElements(B.collectionToElement(e,t),"collections"),this.dataProvider.saveElements(B.collectionResourcesToElements(t,r),"elements")},B.prototype.saveResource=function(t,r){return void 0===r&&(r=[]),H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.saveElements(B.toResourceElements(B.getResourceKey(t),t,r),"elements")]})})},B.collectionToElement=function(e,t){var r={key:e,content:{updated_at:Date.now(),keys:[]}};return t.data.forEach(function(e){var t=B.getResourceKey(e);r.content.keys.push(t)}),[r]},B.collectionResourcesToElements=function(e,r){void 0===r&&(r=[]);var n=[];return e.data.forEach(function(e){var t=B.getResourceKey(e);n.push.apply(n,B.toResourceElements(t,e,r))}),n},B.toResourceElements=function(e,r,t){void 0===t&&(t=[]);var n=[{key:e,content:r.toObject()}];return n[0].content.data.cache_last_update=Date.now(),t.forEach(function(e){var t=r.relationships[e];if(t instanceof x)t.data.forEach(function(e){n.push(B.getElement(e))});else if(t instanceof k){if(null===t.data||void 0===t.data)return;n.push(B.getElement(t.data))}}),n},B.getResourceKey=function(e){return e.type+"."+e.id},B.getElement=function(e){return{key:B.getResourceKey(e),content:e.toObject()}},B.prototype.deprecateCollection=function(t){return H(this,void 0,void 0,function(){return h(this,function(e){return[2,this.dataProvider.updateElements(t,{},"collections")]})})},B);function B(){this.dataProvider=new M}function G(e,t){var r=t&&"number"==typeof t?t:e.ttl||0;return Date.now()<e.cache_last_update+1e3*r}function U(e,t,r){var n=r.value;return r.value=function(){var e,t=Array.prototype.slice.call(arguments);try{e="string"==typeof t[0]?t[0]:t[0].type}catch(e){return console.warn("ERROR: First argument of methods decorated with serviceIsRegistered has to be string or Resource."),null}return te.me.getResourceService(e)?n.apply(this,t):(console.warn("ERROR: "+e+" service has not been registered."),null)},r}var W=function(){this.url="http://yourdomain/api/v1/",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!0,this.cachestore_support=!0,this.parameters={page:{number:"page[number]",size:"page[size]"}}},N=(Q.prototype.exec=function(e,t,r){var n,i=this,o=this.rsJsonapiConfig.url,s={body:r||null,headers:new u.HttpHeaders({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})};if(c.isPlatformServer(this.platformId)&&!o.match(/^http\:|^https\:|^\/\//)&&(o=((n=this.request.headers)["x-forwarded-proto"]?n["x-forwarded-proto"].split(",")[0]:n.proto?n.proto:"http")+"://"+(n["x-forwarded-host"]?n["x-forwarded-host"].split(",")[0]:n.host)+o),"get"!==t)return this.http.request(t,o+e,s).pipe(d.tap(function(){delete i.get_requests[e]}),d.share());if(this.get_requests[e])return this.get_requests[e];var a=this.http.request(t,o+e,s).pipe(d.tap(function(){delete i.get_requests[e]}),d.share());return this.get_requests[e]=a},Q);function Q(e,t,r,n){this.request=e,this.platformId=t,this.http=r,this.rsJsonapiConfig=n,this.get_requests={}}N.decorators=[{type:i.Injectable}],N.ctorParameters=function(){return[{type:void 0,decorators:[{type:i.Optional},{type:i.Inject,args:[r.REQUEST]}]},{type:void 0,decorators:[{type:i.Inject,args:[i.PLATFORM_ID]}]},{type:u.HttpClient},{type:W}]};var V=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}i((c=c.apply(o,s||[])).next())})};var X=(Y.prototype.getDataObject=function(n,i){return V(this,void 0,void 0,function(){var t,r;return h(this,function(e){switch(e.label){case 0:return t="collection"===n?"collections":"elements",[4,this.db.open()];case 1:return e.sent(),[4,this.db.table(t).get(n+"."+i)];case 2:if(void 0===(r=e.sent()))throw new Error;return[2,r]}})})},Y.prototype.getDataResources=function(n){return V(this,void 0,void 0,function(){var t,r;return h(this,function(e){switch(e.label){case 0:return t=this.db.table("elements").where(":id").anyOf(n),r={},[4,t.each(function(e){r[e.id]=e})];case 1:return e.sent(),[2,r]}})})},Y.prototype.saveResource=function(t,r,e){var n=this,i=Object.assign({cache_last_update:Date.now()},e);this.db.open().then(function(){return V(n,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("elements").put(i,t+"."+r)]})})})},Y.prototype.saveCollection=function(t,e){var r=this,n=Object.assign({cache_last_update:Date.now()},e);this.db.open().then(function(){return V(r,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("collections").put(n,"collection."+t)]})})})},Y.prototype.clearCache=function(){var e=this;this.db.open().then(function(){return V(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("elements").toCollection().delete()]})})}),this.db.open().then(function(){return V(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("collections").toCollection().delete()]})})})},Y.prototype.deprecateResource=function(t,r){var e=this;this.db.open().then(function(){return V(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("elements").where(":id").startsWith(t+"."+r).modify({cache_last_update:0})]})})})},Y.prototype.deprecateCollection=function(t){var e=this;this.db.open().then(function(){return V(e,void 0,void 0,function(){return h(this,function(e){return[2,this.db.table("collections").where(":id").startsWith(t).modify({cache_last_update:0})]})})})},Y.prototype.removeObjectsWithKey=function(e){return V(this,void 0,void 0,function(){return h(this,function(e){return[2]})})},Y.prototype.checkIfIsTimeToClean=function(){},Y.prototype.checkAndDeleteOldElements=function(){},Y);function Y(){this.db=new t("jsonapi_db"),this.db.version(1).stores({collections:"",elements:""}),this.checkIfIsTimeToClean()}var Z=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;0<=a;a--)(i=e[a])&&(s=(o<3?i(s):3<o?i(t,r,s):i(t,r))||s);return 3<o&&s&&Object.defineProperty(t,r,s),s},$=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ee=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}i((c=c.apply(o,s||[])).next())})},te=(re.delete=function(e){return re.exec(e,"DELETE")},re.get=function(e){return re.exec(e,"get")},re.exec=function(e,t,r,n){return void 0===n&&(n=!0),re.me.refreshLoadings(1),re.injectedServices.JsonapiHttp.exec(e,t,r).pipe(d.tap(function(){return re.me.refreshLoadings(-1)}),d.catchError(function(e){return e=e.error||e,re.me.refreshLoadings(-1),e.status<=0?!re.me.loadingsOffline(e)&&i.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):n&&!re.me.loadingsError(e)&&i.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),s.throwError(e)}))},re.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e)},re.prototype.getResourceService=function(e){return this.resourceServices[e]},re.prototype.getResourceServiceOrFail=function(e){var t=this.resourceServices[e];if(!t)throw new Error("The requested service with type "+e+" has not been registered, please use register() method or @Autoregister() decorator");return t},re.removeCachedResource=function(e,t){L.getInstance().removeResource(e,t)},re.setCachedResource=function(e){L.getInstance().setResource(e,!0)},re.deprecateCachedCollections=function(e){var t=re.me.getResourceServiceOrFail(e),r=new g;r.applyParams(t),L.getInstance().deprecateCollections(r.getForCache())},re.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},re.prototype.clearCache=function(){return ee(this,void 0,void 0,function(){return h(this,function(e){return re.injectedServices.JsonapiStoreService.clearCache(),L.getInstance().clearCache(),[2,(new z).deprecateCollection("").then(function(){return!0})]})})},re.prototype.duplicateResource=function(r){for(var n=this,i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];var o=this.getResourceServiceOrFail(r.type).new();o.id="new_"+Math.floor(1e4*Math.random()).toString(),o.attributes=Object.assign({},o.attributes,r.attributes);var s=this;for(var t in r.relationships)!function(t){var e=r.relationships[t];if(!e.data)return o.relationships[t]=r.relationships[t];"id"in e.data?-1<i.indexOf(t)?o.addRelationship(s.duplicateResource(e.data),t):o.addRelationship(e.data,t):-1<i.indexOf(t)?e.data.forEach(function(e){o.addRelationship(n.duplicateResource(e),t)}):o.addRelationships(e.data,t)}(t);return o},re);function re(e,t,r){for(var n in this.loadingsCounter=0,this.loadingsStart=s.noop,this.loadingsDone=s.noop,this.loadingsError=s.noop,this.loadingsOffline=s.noop,this.resourceServices={},this.config=new W,this.config)this.config[n]=void 0!==e[n]?e[n]:this.config[n];re.me=this,re.injectedServices={JsonapiStoreService:t,JsonapiHttp:r,rsJsonapiConfig:this.config}}te.decorators=[{type:i.Injectable}],te.ctorParameters=function(){return[{type:W,decorators:[{type:i.Optional}]},{type:X},{type:N}]},Z([U,$("design:type",Function),$("design:paramtypes",[String,String]),$("design:returntype",void 0)],te,"removeCachedResource",null),Z([U,$("design:type",Function),$("design:paramtypes",[j]),$("design:returntype",void 0)],te,"setCachedResource",null),Z([U,$("design:type",Function),$("design:paramtypes",[String]),$("design:returntype",void 0)],te,"deprecateCachedCollections",null);var ne=(ie.forRoot=function(e){return{ngModule:ie,providers:[{provide:W,useValue:e}]}},ie);function ie(e,t){if(e)throw new Error("NgxJsonapiModule is already loaded. Import it in the AppModule only")}ne.decorators=[{type:i.NgModule,args:[{imports:[c.CommonModule],exports:[u.HttpClientModule],providers:[te,X,W,N]}]}],ne.ctorParameters=function(){return[{type:ne,decorators:[{type:i.Optional},{type:i.SkipSelf}]},{type:te}]};var oe=(se.prototype.toparams=function(e){var r=this,n="";return F.forEach(e,function(e,t){n+=r.toparamsarray(e,"&"+t)}),n.slice(1)},se.prototype.toparamsarray=function(e,r){var n=this,i="";return Array.isArray(e)?F.forEach(e,function(e,t){i+=r+"[]="+e}):o.isObject(e)?F.forEach(e,function(e,t){i+=n.toparamsarray(e,r+"["+t+"]")}):i+=r+"="+e,i},se);function se(){}var ae,ce=(p(ue,ae=g),ue.prototype.applyParams=function(e,t){void 0===t&&(t={}),ae.prototype.applyParams.call(this,e,t);var r=new oe;t.remotefilter&&0<Object.keys(t.remotefilter).length&&(e.parseToServer&&e.parseToServer(t.remotefilter),this.addParam(r.toparams({filter:t.remotefilter}))),t.page&&(1<t.page.number&&this.addParam(this.getPageConfig().number+"="+t.page.number),t.page.size&&this.addParam(this.getPageConfig().size+"="+t.page.size)),t.sort&&t.sort.length&&this.addParam("sort="+t.sort.join(","))},ue.prototype.getPageConfig=function(){return te.injectedServices.rsJsonapiConfig.parameters&&te.injectedServices.rsJsonapiConfig.parameters.page||{number:"number",size:"size"}},ue.prototype.addParam=function(e){this.get_params.push(e)},ue);function ue(){return null!==ae&&ae.apply(this,arguments)||this}var de=(pe.prototype.getResourceObject=function(){return this.resource_object},pe.prototype.removeDuplicatedIncludes=function(){if(!this.resource_object.included||!this.parent_resource_object.included)return this;var e=this.parent_resource_object.included;return this.resource_object.included=this.resource_object.included.filter(function(t){return!n.isEqual(t,e.find(function(e){return e.id===t.id}))}),this.resource_object.included=this.resource_object.included.map(function(t){return e.find(function(e){return e.id===t.id})?new pe(t,e.find(function(e){return e.id===t.id})).getResourceObject().data:t}),this},pe.prototype.removeDuplicatedRelationships=function(){if(!this.resource_object.data.relationships||!this.parent_resource_object.data.relationships)return this;for(var e in this.resource_object.data.relationships)n.isEqual(this.resource_object.data.relationships[e],this.parent_resource_object.data.relationships[e])&&delete this.resource_object.data.relationships[e];return this},pe.prototype.removeDuplicatedAttributes=function(){if(!this.resource_object.data.attributes||!this.parent_resource_object.data.attributes)return this;for(var e in this.resource_object.data.attributes)this.resource_object.data.attributes[e]===this.parent_resource_object.data.attributes[e]&&delete this.resource_object.data.attributes[e];return this},pe);function pe(e,t,r){var n;this.parent_resource_object=t instanceof j?t.toObject(r):{data:t},(n=e)&&n.toObject&&"function"==typeof n.toObject&&n.superToObject&&"function"==typeof n.superToObject?this.resource_object=e.superToObject(r):this.resource_object={data:e},this.removeDuplicatedAttributes(),this.removeDuplicatedRelationships(),this.removeDuplicatedIncludes()}var he,le=(p(fe,he=j),fe.prototype.toObject=function(e){return new de(this,this.parent,e).getResourceObject()},fe.prototype.superToObject=function(e){return he.prototype.toObject.call(this,e)},fe.prototype.copySourceFromParent=function(){for(var e in this.source=this.parent.source,this.relationships)this.relationships[e].source=this.parent.relationships[e].source},fe);function fe(e){var t=he.call(this)||this;t.parent=n.cloneDeep(e),t.type=t.parent.type,delete t.relationships;var r=Object.keys(t.parent.relationships);return t.fill(t.parent.toObject({include:r})),t.copySourceFromParent(),t}var ve=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}i((c=c.apply(o,s||[])).next())})},ge=(ye.prototype.register=function(){if(null===te.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return te.me.registerService(this)},ye.prototype.newResource=function(){return this.new()},ye.prototype.newCollection=function(){return new x},ye.prototype.new=function(){var e=new this.resource;return e.type=this.type,this.getService(),e.reset(),e},ye.prototype.getPrePath=function(){return""},ye.prototype.getPath=function(){return this.path||this.type},ye.prototype.getClone=function(e,t){return void 0===t&&(t={}),this.get(e,t).pipe(d.map(function(e){return new le(e)}))},ye.prototype.pathForGet=function(e,t){void 0===t&&(t={}),t=Object.assign({},F.ParamsResource,t);var r=new g;return r.applyParams(this,t),r.appendPath(e),r.get()},ye.prototype.get=function(e,t){var r=this;void 0===t&&(t={}),t=Object.assign({},F.ParamsResource,t);var n=new g;n.applyParams(this,t),n.appendPath(e);var i=this.getOrCreateResource(e);i.setLoaded(!1);var o=new s.BehaviorSubject(i);return 0<Object.keys(t.fields||[]).length?this.getGetFromServer(n,i,o):G(i,t.ttl)&&function(e,t){if(0===t.length)return 1;for(var r in e.relationships)if(t.includes(r)&&!e.relationships[r].builded)return;return 1}(i,t.include||[])?(i.setLoaded(!0),setTimeout(function(){return o.complete()},0)):0===i.cache_last_update?this.getGetFromLocal(t,n,i).then(function(){o.next(i),setTimeout(function(){return o.complete()},0)}).catch(function(){i.setLoaded(!1),r.getGetFromServer(n,i,o)}):this.getGetFromServer(n,i,o),o.asObservable()},ye.prototype.getGetFromLocal=function(r,n,i){return void 0===r&&(r={}),ve(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:if(!te.injectedServices.rsJsonapiConfig.cachestore_support)throw new Error("We cant handle this request");return i.setLoaded(!1),[4,(new z).getResource(z.getResourceKey(i),n.includes)];case 1:if(t=e.sent(),i.fill(t),i.setSource("store"),G(i,r.ttl))return i.setLoadedAndPropagate(!0),[2];throw new Error("Resource is dead!")}})})},ye.prototype.getGetFromServer=function(t,r,n){te.get(t.get()).subscribe(function(e){r.fill(e),r.cache_last_update=Date.now(),r.setLoadedAndPropagate(!0),r.setSourceAndPropagate("server"),te.injectedServices.rsJsonapiConfig.cachestore_support&&(new z).saveResource(r,t.includes),n.next(r),setTimeout(function(){return n.complete()},0)},function(e){r.setLoadedAndPropagate(!0),n.next(r),n.error(e)})},ye.prototype.getService=function(){return b.getService(this.type)||this.register()},ye.prototype.getOrCreateCollection=function(e){var t=this.getService(),r=L.getInstance().getOrCreateCollection(e.getForCache());return r.ttl=t.collections_ttl,"new"!==r.source&&(r.source="memory"),r},ye.prototype.getOrCreateResource=function(e){var t=this.getService(),r=L.getInstance().getResource(this.type,e);return null===r&&((r=t.new()).id=e,L.getInstance().setResource(r,!1)),"new"!==r.source&&(r.source="memory"),r},ye.prototype.createResource=function(e){var t=b.getServiceOrFail(this.type).new();return t.id=e,L.getInstance().setResource(t,!1),t},ye.prototype.clearCacheMemory=function(){return ve(this,void 0,void 0,function(){return h(this,function(e){return[2,this.clearCache()]})})},ye.prototype.clearCache=function(){return ve(this,void 0,void 0,function(){var t;return h(this,function(e){return(t=new g).applyParams(this),L.getInstance().deprecateCollections(t.getForCache()),[2,(new z).deprecateCollection(t.getForCache()).then(function(){return!0})]})})},ye.prototype.parseToServer=function(e){},ye.prototype.parseFromServer=function(e){},ye.prototype.delete=function(t,e){var r=this;e=Object.assign({},F.ParamsResource,e);var n=new g;n.applyParams(this,e),n.appendPath(t);var i=new s.Subject;return te.delete(n.get()).subscribe(function(e){L.getInstance().removeResource(r.type,t),i.next(),i.complete()},function(e){i.error(e)}),i.asObservable()},ye.prototype.pathForAll=function(e){void 0===e&&(e={});var t=Object.assign({},F.ParamsCollection,e),r=new ce;return r.applyParams(this,t),r.get()},ye.prototype.all=function(e){var t=this;void 0===e&&(e={});var r=Object.assign({},F.ParamsCollection,e);r.ttl||0===r.ttl||(r.ttl=this.collections_ttl);var n=new ce;n.applyParams(this,r);var i=this.getOrCreateCollection(n);i.page.number=+r.page.number;var o=new s.BehaviorSubject(i);return 0<Object.keys(r.fields).length?this.getAllFromServer(n,r,i,o):G(i,r.ttl)?setTimeout(function(){return o.complete()},0):0===i.cache_last_update?(i.source="new",this.getAllFromLocal(r,n,i).then(function(){o.next(i),setTimeout(function(){o.complete()},0)}).catch(function(){i.setLoaded(!1),t.getAllFromServer(n,r,i,o)})):this.getAllFromServer(n,r,i,o),o.asObservable()},ye.prototype.getAllFromLocal=function(r,n,i){return void 0===r&&(r={}),ve(this,void 0,void 0,function(){var t;return h(this,function(e){switch(e.label){case 0:if(!te.injectedServices.rsJsonapiConfig.cachestore_support)throw new Error("We cant handle this request");return i.setLoaded(!1),"compact"!==r.store_cache_method?[3,2]:[4,te.injectedServices.JsonapiStoreService.getDataObject("collection",n.getForCache()+".compact")];case 1:return t=e.sent(),[3,4];case 2:return[4,(new z).getCollection(n.getForCache(),n.includes)];case 3:t=e.sent(),e.label=4;case 4:if(i.fill(t),i.setSourceAndPropagate("store"),G(i,r.ttl))return i.setLoadedAndPropagate(!0),i.setBuildedAndPropagate(!0),[2];throw new Error("Collection is dead!")}})})},ye.prototype.getAllFromServer=function(n,i,o,s){o.setLoaded(!1),te.get(n.get()).subscribe(function(e){if(i.cachehash)for(var t in e.data){var r=e.data[t];r.id=r.id+i.cachehash}o.fill(e),o.cache_last_update=Date.now(),o.setCacheLastUpdateAndPropagate(),o.setSourceAndPropagate("server"),o.setLoadedAndPropagate(!0),te.injectedServices.rsJsonapiConfig.cachestore_support&&(new z).saveCollection(n.getForCache(),o,n.includes),te.injectedServices.rsJsonapiConfig.cachestore_support&&"compact"===i.store_cache_method&&te.injectedServices.JsonapiStoreService.saveCollection(n.getForCache()+".compact",e),s.next(o),setTimeout(function(){return s.complete()},0)},function(e){o.setLoadedAndPropagate(!0),s.next(o),s.error(e)})},ye);function ye(){var e=this;this.resource=j,setTimeout(function(){return e.register()})}e.Autoregister=function(){return function(e){}},e.JsonapiCore=te,e.Resource=j,e.DocumentResource=k,e.DocumentCollection=x,e.Service=ge,e.NgxJsonapiModule=ne,e.ɵe=O,e.ɵa=C,e.ɵb=W,e.ɵd=N,e.ɵc=X,Object.defineProperty(e,"__esModule",{value:!0})});